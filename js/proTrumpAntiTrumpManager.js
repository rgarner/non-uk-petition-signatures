// Generated by CoffeeScript 1.9.3
(function() {
  var DuellingPetitions, ProAntiTrumpView,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  DuellingPetitions = (function() {
    var get;

    function DuellingPetitions(url1, url2) {
      this.url1 = url1;
      this.url2 = url2;
      this.byConstituency = bind(this.byConstituency, this);
      this.stats = bind(this.stats, this);
      this.totalSignatures = bind(this.totalSignatures, this);
      this.getBoth = bind(this.getBoth, this);
    }

    get = function(url) {
      return $.ajax({
        url: url.toString(),
        dataType: "json",
        error: function(jqXHR, textStatus, errorThrown) {
          return console.log("Couldn't get petition JSON - " + textStatus + ": " + errorThrown);
        },
        success: (function(_this) {
          return function(petitionJson) {
            return console.log("got " + url + " JSON:", petitionJson);
          };
        })(this)
      });
    };

    DuellingPetitions.prototype.getBoth = function(callback) {
      return $.when(get(this.url1), get(this.url2)).done((function(_this) {
        return function(a1, a2) {
          _this.petition1 = new PetitionData(a1[0]);
          _this.petition2 = new PetitionData(a2[0]);
          return callback();
        };
      })(this));
    };

    DuellingPetitions.prototype.totalSignatures = function() {
      return this.petition1.stats().total + this.petition2.stats().total;
    };

    DuellingPetitions.prototype.stats = function() {
      var stats, total;
      stats = [this.petition1.stats(), this.petition2.stats()];
      total = stats[0].total + stats[1].total;
      return {
        total: total,
        petitions: [
          {
            title: this.petition1.title(),
            total: stats[0].total,
            percentage: (stats[0].total / total) * 100
          }, {
            title: this.petition2.title(),
            total: stats[1].total,
            percentage: (stats[1].total / total) * 100
          }
        ]
      };
    };

    DuellingPetitions.prototype.byConstituency = function() {
      var percentage;
      percentage = function(c1, c2) {
        var total;
        total = c1.signature_count + c2.signature_count;
        return (c1.signature_count / total) * 100;
      };
      return this.petition1.signaturesByConstituency().map((function(_this) {
        return function(constituency) {
          var constituency2, mappedConstituency;
          constituency2 = _this.petition2.signaturesByConstituency().find(function(c) {
            return c.ons_code === constituency.ons_code;
          });
          mappedConstituency = {
            name: constituency.name,
            mp: constituency.mp,
            ons_code: constituency.ons_code,
            petitions: [
              {
                title: _this.petition1.title(),
                signature_count: constituency.signature_count,
                percentage: percentage(constituency, constituency2)
              }, {
                title: _this.petition2.title(),
                signature_count: constituency2.signature_count,
                percentage: percentage(constituency2, constituency)
              }
            ]
          };
          return mappedConstituency;
        };
      })(this));
    };

    return DuellingPetitions;

  })();

  ProAntiTrumpView = (function() {
    var drawTable, setupSummaryProgressBar, setupTitle;

    function ProAntiTrumpView(duellingPetitions1) {
      this.duellingPetitions = duellingPetitions1;
      this.draw = bind(this.draw, this);
    }

    drawTable = function(tableBody) {
      var constituency, i, len, results, sortedByDescendingPetition1Percentage;
      tableBody.find('tr').remove();
      sortedByDescendingPetition1Percentage = this.duellingPetitions.byConstituency().sort(function(c1, c2) {
        if (c1.petitions[0].percentage < c2.petitions[0].percentage) {
          return 1;
        } else {
          return -1;
        }
      });
      results = [];
      for (i = 0, len = sortedByDescendingPetition1Percentage.length; i < len; i++) {
        constituency = sortedByDescendingPetition1Percentage[i];
        results.push(tableBody.append("<tr>\n  <td class='title'>" + constituency.name + "</td>\n  <td class='bar'>\n    <div class=\"progress-bar\" style='width: " + constituency.petitions[0].percentage + "%'>\n        <span>" + (constituency.petitions[0].percentage.toFixed(1)) + "%</span>\n    </div>\n    <div class=\"progress-bar progress-bar-warning\" role=\"progressbar\" style='width: " + constituency.petitions[1].percentage + "%'>\n        <span>" + (constituency.petitions[1].percentage.toFixed(1)) + "%</span>\n    </div>\n  </td>\n</tr>"));
      }
      return results;
    };

    setupTitle = function() {
      return $('.subtitle .n').text(this.duellingPetitions.totalSignatures().toLocaleString('en-GB', {
        minimumFractionDigits: 0
      }));
    };

    setupSummaryProgressBar = function() {
      var stats;
      stats = this.duellingPetitions.stats();
      console.log(stats);
      $('.progress-bar-anti-trump').attr('style', "width: " + (stats.petitions[0].percentage.toFixed(1)) + "%");
      $('.progress-bar-anti-trump span').text((stats.petitions[0].total.toLocaleString('en-GB', {
        minimumFractionDigits: 0
      })) + " (" + (stats.petitions[0].percentage.toFixed(1)) + "%) are anti-Trump.");
      $('.progress-bar-pro-trump').attr('style', "width: " + (stats.petitions[1].percentage.toFixed(1)) + "%");
      return $('.progress-bar-pro-trump span').text((stats.petitions[1].total.toLocaleString('en-GB', {
        minimumFractionDigits: 0
      })) + " (" + (stats.petitions[1].percentage.toFixed(1)) + "%) pro.");
    };

    ProAntiTrumpView.prototype.draw = function(tableBody) {
      setupTitle.call(this);
      setupSummaryProgressBar.call(this);
      return drawTable.call(this, tableBody);
    };

    return ProAntiTrumpView;

  })();

  this.ProTrumpAntiTrumpManager = (function() {
    function ProTrumpAntiTrumpManager() {}

    ProTrumpAntiTrumpManager.prototype.setup = function(ukOrNonUk) {
      var antiTrump, duellingPetitions, proTrump;
      antiTrump = 'https://petition.parliament.uk/petitions/171928.json';
      proTrump = 'https://petition.parliament.uk/petitions/178844.json';
      duellingPetitions = new DuellingPetitions(antiTrump, proTrump);
      return duellingPetitions.getBoth(function() {
        var view;
        view = new ProAntiTrumpView(duellingPetitions);
        return view.draw($('#bars tbody'));
      });
    };

    return ProTrumpAntiTrumpManager;

  })();

}).call(this);

//# sourceMappingURL=proTrumpAntiTrumpManager.js.map
